# Архитектура развёртывания

## Общая схема

```
┌─────────────────────────────────────────────────────────────┐
│                  Ubuntu Server (Хост)                        │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  Установлено напрямую в ОС:                        │    │
│  │  • Docker & Docker Compose                         │    │
│  │  • Nginx (reverse proxy)                           │    │
│  │  • Certbot (SSL сертификаты)                       │    │
│  │  • Git (для клонирования кода)                     │    │
│  │  • UFW (firewall)                                  │    │
│  │  • Node.js (опционально, для скриптов)             │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  Docker контейнеры:                                 │    │
│  │                                                     │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │    │
│  │  │ PostgreSQL   │  │   Redis      │  │   API    │ │    │
│  │  │ Container    │  │  Container   │  │ Container│ │    │
│  │  │ Port: 5432   │  │ Port: 6379   │  │ Port:    │ │    │
│  │  │ (internal)   │  │ (internal)   │  │ 3000/3001│ │    │
│  │  └──────────────┘  └──────────────┘  └──────────┘ │    │
│  │                                                     │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Nginx проксирует на localhost:3000
                            ↓
              ┌─────────────────────────────┐
              │   Интернет (порты 80/443)   │
              └─────────────────────────────┘
```

## Что устанавливается напрямую в ОС

### 1. Docker & Docker Compose
**Зачем:** Управление контейнерами приложений

```bash
# Установка
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
```

**Почему в ОС, а не в контейнере:**
- Docker должен быть на хосте для запуска других контейнеров
- Это основа инфраструктуры

---

### 2. Nginx
**Зачем:** Reverse proxy, SSL терминация, маршрутизация

```bash
# Установка
sudo apt install -y nginx
```

**Конфигурация:** `/etc/nginx/sites-available/wmoc.online`

**Почему в ОС, а не в контейнере:**
- ✅ Проще управлять SSL сертификатами (Certbot интегрирован с системным Nginx)
- ✅ Стабильность (Nginx на хосте более надёжен)
- ✅ Производительность (меньше overhead)
- ✅ Стандартная практика (Nginx часто используется как edge proxy)
- ✅ Проще настройка firewall (порты 80/443 на хосте)

**Альтернатива:** Можно использовать Nginx в Docker, но это усложняет управление SSL.

---

### 3. Certbot
**Зачем:** Автоматическое получение и обновление SSL сертификатов Let's Encrypt

```bash
# Установка
sudo apt install -y certbot python3-certbot-nginx
```

**Почему в ОС:**
- Интегрирован с системным Nginx
- Автоматическое обновление через systemd timer
- Доступ к файловой системе для сертификатов

---

### 4. Git
**Зачем:** Клонирование и обновление кода проекта

```bash
# Установка
sudo apt install -y git
```

---

### 5. UFW (Firewall)
**Зачем:** Безопасность, контроль сетевого трафика

```bash
# Установка (обычно уже установлен)
sudo apt install -y ufw
```

**Настройка:**
```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

---

### 6. Node.js (Опционально)
**Зачем:** Запуск скриптов миграций, утилит (если не используем Docker)

```bash
# Установка (только если нужно запускать скрипты на хосте)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
```

**Когда не нужен:**
- Если все миграции выполняются через Docker контейнеры
- Если все скрипты запускаются через `docker-compose exec`

---

## Что работает в Docker контейнерах

### 1. PostgreSQL
**Контейнер:** `postgres:15-alpine`

**Почему в Docker:**
- ✅ Изоляция данных и процессов
- ✅ Легко обновлять версию
- ✅ Простое управление через docker-compose
- ✅ Легко делать бэкапы (volumes)
- ✅ Можно быстро пересоздать при проблемах

**Порты:**
- Внутренний: `5432` (доступен только внутри Docker сети)
- Внешний: `127.0.0.1:5432` (только локальный доступ с хоста)

**Volumes:**
- `postgres_data` - данные БД
- `./backups` - директория для бэкапов (монтируется с хоста)

---

### 2. Redis
**Контейнер:** `redis:7-alpine`

**Почему в Docker:**
- ✅ Изоляция
- ✅ Легкое управление
- ✅ Конфигурация через docker-compose
- ✅ Автоматический restart при сбоях

**Порты:**
- Внутренний: `6379` (доступен только внутри Docker сети)
- Внешний: `127.0.0.1:6379` (только локальный доступ с хоста)

**Volumes:**
- `redis_data` - данные Redis (AOF файлы)

---

### 3. Node.js API (Backend приложение)
**Контейнер:** Собственный образ (собирается из Dockerfile)

**Почему в Docker:**
- ✅ Изоляция зависимостей
- ✅ Консистентность окружения (dev/prod одинаковое)
- ✅ Легко масштабировать (можно запустить несколько инстансов)
- ✅ Простое обновление (пересборка образа)
- ✅ Управление через docker-compose

**Порты:**
- Внутренний: `3000` (HTTP API), `3001` (WebSocket tunnel)
- Внешний: `127.0.0.1:3000` и `127.0.0.1:3001` (доступны только для Nginx на хосте)

**Volumes:**
- `./logs:/app/logs` - логи приложения (монтируются с хоста для доступа)

**Зависимости:**
- Зависит от PostgreSQL и Redis контейнеров
- Запускается только после их готовности

---

## Сетевая архитектура

### Порты на хосте (Ubuntu Server)

| Порт | Процесс | Доступ | Назначение |
|------|---------|--------|------------|
| 22   | SSH     | Внешний | Удалённое управление |
| 80   | Nginx   | Внешний | HTTP → HTTPS редирект |
| 443  | Nginx   | Внешний | HTTPS трафик |
| 3000 | API (Docker) | Локальный (127.0.0.1) | Backend API |
| 3001 | API (Docker) | Локальный (127.0.0.1) | WebSocket tunnel |
| 5432 | PostgreSQL (Docker) | Локальный (127.0.0.1) | База данных |
| 6379 | Redis (Docker) | Локальный (127.0.0.1) | Кеш |

### Docker сеть

Все контейнеры находятся в одной Docker сети (создаётся автоматически docker-compose):

```
API контейнер → postgres:5432 (по имени сервиса)
API контейнер → redis:6379 (по имени сервиса)
```

### Поток запросов

```
Интернет (443)
    ↓
Nginx (на хосте)
    ↓
localhost:3000 (API контейнер)
    ↓
postgres:5432 (PostgreSQL контейнер, через Docker сеть)
redis:6379 (Redis контейнер, через Docker сеть)
```

---

## Файловая структура на хосте

```
/home/wmoc/
└── wmoc-server/              # Клонированный репозиторий
    └── server/
        ├── .env              # Переменные окружения
        ├── docker-compose.prod.yml
        ├── Dockerfile
        ├── src/              # Исходный код
        ├── logs/             # Логи приложения (монтируются в контейнер)
        └── backups/          # Бэкапы БД (монтируются в PostgreSQL контейнер)

/etc/nginx/
└── sites-available/
    └── wmoc.online           # Конфигурация Nginx

/etc/letsencrypt/
└── live/
    └── wmoc.online/          # SSL сертификаты

/var/lib/docker/
└── volumes/                  # Docker volumes (PostgreSQL, Redis данные)
    ├── wmoc-postgres_data/
    └── wmoc-redis_data/
```

---

## Альтернативные варианты развёртывания

### Вариант 1: Все в Docker (включая Nginx)

**Плюсы:**
- Полная изоляция всего стека
- Единое управление через docker-compose

**Минусы:**
- Сложнее управлять SSL сертификатами
- Nginx контейнер должен иметь доступ к портам 80/443 (нужен `network_mode: host`)
- Менее стандартная конфигурация

### Вариант 2: Все на хосте (без Docker)

**Плюсы:**
- Проще для начинающих
- Меньше overhead

**Минусы:**
- Сложнее управлять зависимостями
- Сложнее масштабировать
- Проблемы с версиями зависимостей
- Сложнее делать обновления

### Вариант 3: Гибридный (Рекомендуемый) ✅

**Текущий подход:**
- Инфраструктура (Nginx, SSL) на хосте
- Приложения (API, БД, Redis) в Docker

**Почему оптимален:**
- Баланс между простотой и гибкостью
- Стандартная практика
- Легко масштабировать приложения
- Просто управлять инфраструктурой

---

## Команды управления

### Запуск всех сервисов
```bash
cd ~/wmoc-server/server
docker-compose -f docker-compose.prod.yml up -d
```

### Остановка всех сервисов
```bash
docker-compose -f docker-compose.prod.yml down
```

### Просмотр логов
```bash
# Все контейнеры
docker-compose -f docker-compose.prod.yml logs -f

# Конкретный контейнер
docker-compose -f docker-compose.prod.yml logs -f api
```

### Перезапуск Nginx
```bash
sudo systemctl reload nginx
```

### Обновление SSL сертификатов
```bash
sudo certbot renew
```

---

## Резюме

| Компонент | Где установлен | Почему |
|-----------|----------------|--------|
| **Docker** | Хост (ОС) | Основа инфраструктуры |
| **Nginx** | Хост (ОС) | Edge proxy, SSL терминация |
| **Certbot** | Хост (ОС) | Управление SSL |
| **Git** | Хост (ОС) | Управление кодом |
| **PostgreSQL** | Docker | Изоляция, управляемость |
| **Redis** | Docker | Изоляция, управляемость |
| **Node.js API** | Docker | Изоляция, масштабируемость |

**Принцип:** Инфраструктурные сервисы на хосте, бизнес-логика в контейнерах.

